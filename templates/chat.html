{% extends 'base.html' %}
{% load static %}



{% block basepage %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellness Chatbot</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: black;
            color: white;
        }
        .chat-container {
            width: 100%;
            max-width: 950px; /* Increased max-width for larger chatbot box */
            background-color: #111;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 50px;
        }
        .chat-header {
            background-color: #444;
            color: white;
            padding: 15px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        .chat-box {
            height: calc(100vh - 240px);
            overflow-y: auto;
            padding: 15px;
            color: #ddd; /* Default color for messages */
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            line-height: 1.6;
        }
        .user-message {
            background-color: #222;
            text-align: right;
        }
        .ai-message {
            background-color: #333; 
            text-align: left; 
            color: white; /* Set bot message text to white */
        }
        .ai-message h3 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: white; /* Header color */
        }
        .ai-message strong {
            font-weight: bold; 
            color: white; /* Strong text color */
        }
        .chat-input {
            display: flex; 
            padding: 15px; 
            background-color: #222; 
        }
        .chat-input input {
            flex: 1; 
            padding: 10px; 
            border: 1px solid #444; 
            border-radius: 4px; 
            font-size: 16px; 
            background-color: #333; 
            color: white; 
        }
        .chat-input button {
             padding: 10px 20px; 
             background-color:#444; 
             color:white; 
             border:none; 
             border-radius:4px; 
             margin-left :15px; /* Increased margin for more space */
             cursor:pointer; 
             font-size :16px; 
         }
         .chat-input button:hover { 
             background-color :#666; /* Hover effect for button */
         }  
     </style>  
</head>  
<body>  
    
    <div class="chat-container">  
        <a href="{% url 'wellnessdata' %}" class="back-button">
            <img src="{% static 'images/backbutton1.png' %}" alt="Back" title="Go back">
        </a>
        <div class="chat-header">Wellness Chatbot</div>  
        
        <div class="chat-box" id="chat-box">  
           <!-- Chat messages will be appended here -->  
           {% if user_input %}  
                <div class="message user-message"><strong>YOU:</strong> {{ user_input }}</div>  
           {% endif %}  
           {% if response %}  
                <div class="message ai-message"><strong>AI:</strong> {{ response }}</div>  
           {% endif %}  
       </div>  

       <div class="chat-input">  
           <input type="text" id="message-input" placeholder="Ask about information..." aria-label="Type your message">  
           <button onclick="sendMessage()">Send</button>  
       </div>  
   </div>  

   <script>
       function getCookie(name) {  
           let cookieValue = null;  
           if (document.cookie && document.cookie !== '') {  
               const cookies = document.cookie.split(';');  
               for (let i = 0; i < cookies.length; i++) {  
                   const cookie = cookies[i].trim();  
                   if (cookie.substring(0, name.length + 1) === (name + '=')) {  
                       cookieValue = decodeURIComponent(cookie.substring(name.length + 1));  
                       break;  
                   }  
               }  
           }  
           return cookieValue;   
       }  

       const csrftoken = getCookie('csrftoken');  

       function sendMessage() {   
           const messageInput = document.getElementById('message-input');   
           const message = messageInput.value.trim();   
           if (message === '') return;

           appendMessage('user', message);   

           fetch('{% url "chatbot" %}', {   
               method:'POST',   
               headers:{   
                   'Content-Type':'application/json', // Changed to application/json
                   'X-CSRFToken': csrftoken   
               },   
               body: JSON.stringify({ user_input: message }) // Properly formatted JSON payload
           })   
           .then(response => {    
               if (!response.ok) {    
                   throw new Error(`HTTP error! status:${response.status}`);    
               }    
               return response.json();    
           })    
           .then(data => {    
               appendMessage('ai', data.response);    
           })    
           .catch(error => {    
               console.error('Error:', error);    
               appendMessage('error', `Error:${error.message}`);    
           });    

           messageInput.value = '';   
       }    

       function appendMessage(type, content) {    
           const chatBox = document.getElementById('chat-box');    
           const messageElement = document.createElement('div');    
           messageElement.classList.add('message');    
           messageElement.classList.add(type === 'user' ? 'user-message' : 'ai-message');    

           if (type === 'user') {    
               messageElement.innerHTML = `<strong>You:</strong> ${content}`;    
           } else {    
               messageElement.innerHTML = `<strong>Bot:</strong> ${formatAIResponse(content)}`;    
           }    

           chatBox.appendChild(messageElement);    
           chatBox.scrollTop = chatBox.scrollHeight;    
       }    

       function formatAIResponse(content) {    
          // Remove all asterisks and extra spaces
          content = content.replace(/\*/g, '').replace(/\s+/g, ' ').trim();

          // Split content into lines
          const lines = content.split(/\.\s+/);

          let formattedContent = '';

          lines.forEach(line => {
              line = line.trim();
              if (line) {
                  // Check if the line is a header (starts with a capital letter)
                  if (/^[A-Z]/.test(line)) {
                      formattedContent += `<h3>${line}</h3>`;
                  } else {
                      formattedContent += `<p>${line}.</p>`;
                  }
              }
          });

          return formattedContent;

      }

      // Add event listener for Enter key
      document.getElementById('message-input').addEventListener('keypress', function(event) {     
          if (event.key === 'Enter') {     
              sendMessage();     
          }     
      });     
   </script>     
</body> 
{% block navbar %}

{% endblock navbar %}

{% block footer %}
{% endblock footer %}    
</html>

{% endblock basepage %}